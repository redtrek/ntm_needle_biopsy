\doxysection{/home/redtrek/\+NTM/ntm\+\_\+needle\+\_\+biopsy/code/biopsy\+\_\+needle/src/msc\+\_\+disk.c File Reference}
\hypertarget{msc__disk_8c}{}\label{msc__disk_8c}\index{/home/redtrek/NTM/ntm\_needle\_biopsy/code/biopsy\_needle/src/msc\_disk.c@{/home/redtrek/NTM/ntm\_needle\_biopsy/code/biopsy\_needle/src/msc\_disk.c}}
{\ttfamily \#include $<$assert.\+h$>$}\newline
{\ttfamily \#include $<$stdarg.\+h$>$}\newline
{\ttfamily \#include $<$stdio.\+h$>$}\newline
{\ttfamily \#include $<$tusb.\+h$>$}\newline
{\ttfamily \#include $<$pico/stdlib.\+h$>$}\newline
{\ttfamily \#include "{}diskio.\+h"{}}\newline
{\ttfamily \#include "{}my\+\_\+debug.\+h"{}}\newline
{\ttfamily \#include "{}class/msc/msc.\+h"{}}\newline
{\ttfamily \#include "{}ff.\+h"{}}\newline
Include dependency graph for msc\+\_\+disk.\+c\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{msc__disk_8c__incl}
\end{center}
\end{figure}
\doxysubsubsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \mbox{\hyperlink{msc__disk_8c_a36ee3cef7e2f801857f2203f549d2a8c}{TRACE\+\_\+\+PRINTF}}(fmt,  args...)
\end{DoxyCompactItemize}
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \mbox{\hyperlink{msc__disk_8c_ae2aefd1e5c3d470f440cd8f07dce9991}{tud\+\_\+msc\+\_\+inquiry\+\_\+cb}} (uint8\+\_\+t lun, uint8\+\_\+t vendor\+\_\+id\mbox{[}8\mbox{]}, uint8\+\_\+t product\+\_\+id\mbox{[}16\mbox{]}, uint8\+\_\+t product\+\_\+rev\mbox{[}4\mbox{]})
\begin{DoxyCompactList}\small\item\em Handles the INQUIRY request. \end{DoxyCompactList}\item 
bool \mbox{\hyperlink{msc__disk_8c_abbb293c273679cadfae2b360ccd5e437}{tud\+\_\+msc\+\_\+test\+\_\+unit\+\_\+ready\+\_\+cb}} (uint8\+\_\+t lun)
\begin{DoxyCompactList}\small\item\em Checks if the unit is ready. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{msc__disk_8c_a187bf69a8d208e32b862489fe4caa23d}{tud\+\_\+msc\+\_\+capacity\+\_\+cb}} (uint8\+\_\+t lun, uint32\+\_\+t \texorpdfstring{$\ast$}{*}block\+\_\+count\+\_\+p, uint16\+\_\+t \texorpdfstring{$\ast$}{*}block\+\_\+size\+\_\+p)
\begin{DoxyCompactList}\small\item\em Gets the capacity of the disk. \end{DoxyCompactList}\item 
bool \mbox{\hyperlink{msc__disk_8c_ac5112ed309407dee0e18a97ca415929c}{tud\+\_\+msc\+\_\+start\+\_\+stop\+\_\+cb}} (uint8\+\_\+t lun, uint8\+\_\+t power\+\_\+condition, bool start, bool load\+\_\+eject)
\begin{DoxyCompactList}\small\item\em Callback for the Mass Storage Class\textquotesingle{}s START STOP UNIT request. \end{DoxyCompactList}\item 
int32\+\_\+t \mbox{\hyperlink{msc__disk_8c_a148e0153ce23f6ffd6305fb0e0fc4dfd}{tud\+\_\+msc\+\_\+read10\+\_\+cb}} (uint8\+\_\+t lun, uint32\+\_\+t lba, uint32\+\_\+t offset, void \texorpdfstring{$\ast$}{*}buffer, uint32\+\_\+t bufsize)
\begin{DoxyCompactList}\small\item\em Reads data from the disk. \end{DoxyCompactList}\item 
bool \mbox{\hyperlink{msc__disk_8c_a47fd17807a02c00f4f45880d7f0ad0fa}{tud\+\_\+msc\+\_\+is\+\_\+writable\+\_\+cb}} (uint8\+\_\+t lun)
\begin{DoxyCompactList}\small\item\em Returns true if the MSC is writable. \end{DoxyCompactList}\item 
int32\+\_\+t \mbox{\hyperlink{msc__disk_8c_a375a5cc4f5760603edf955765eca41a8}{tud\+\_\+msc\+\_\+write10\+\_\+cb}} (uint8\+\_\+t lun, uint32\+\_\+t lba, uint32\+\_\+t offset, uint8\+\_\+t \texorpdfstring{$\ast$}{*}buffer, uint32\+\_\+t bufsize)
\begin{DoxyCompactList}\small\item\em Write data to the disk. \end{DoxyCompactList}\item 
int32\+\_\+t \mbox{\hyperlink{msc__disk_8c_a8f5dcb9aacaba9e9932f2c941d4639e3}{tud\+\_\+msc\+\_\+scsi\+\_\+cb}} (uint8\+\_\+t lun, uint8\+\_\+t const scsi\+\_\+cmd\mbox{[}16\mbox{]}, void \texorpdfstring{$\ast$}{*}buffer, uint16\+\_\+t bufsize)
\begin{DoxyCompactList}\small\item\em Callback for handling SCSI commands. \end{DoxyCompactList}\end{DoxyCompactItemize}


\doxysubsection{Macro Definition Documentation}
\Hypertarget{msc__disk_8c_a36ee3cef7e2f801857f2203f549d2a8c}\label{msc__disk_8c_a36ee3cef7e2f801857f2203f549d2a8c} 
\index{msc\_disk.c@{msc\_disk.c}!TRACE\_PRINTF@{TRACE\_PRINTF}}
\index{TRACE\_PRINTF@{TRACE\_PRINTF}!msc\_disk.c@{msc\_disk.c}}
\doxysubsubsection{\texorpdfstring{TRACE\_PRINTF}{TRACE\_PRINTF}}
{\footnotesize\ttfamily \#define TRACE\+\_\+\+PRINTF(\begin{DoxyParamCaption}\item[{}]{fmt,  }\item[{}]{args... }\end{DoxyParamCaption})}



Definition at line \mbox{\hyperlink{msc__disk_8c_source_l00057}{57}} of file \mbox{\hyperlink{msc__disk_8c_source}{msc\+\_\+disk.\+c}}.



\doxysubsection{Function Documentation}
\Hypertarget{msc__disk_8c_a187bf69a8d208e32b862489fe4caa23d}\label{msc__disk_8c_a187bf69a8d208e32b862489fe4caa23d} 
\index{msc\_disk.c@{msc\_disk.c}!tud\_msc\_capacity\_cb@{tud\_msc\_capacity\_cb}}
\index{tud\_msc\_capacity\_cb@{tud\_msc\_capacity\_cb}!msc\_disk.c@{msc\_disk.c}}
\doxysubsubsection{\texorpdfstring{tud\_msc\_capacity\_cb()}{tud\_msc\_capacity\_cb()}}
{\footnotesize\ttfamily void tud\+\_\+msc\+\_\+capacity\+\_\+cb (\begin{DoxyParamCaption}\item[{uint8\+\_\+t}]{lun,  }\item[{uint32\+\_\+t \texorpdfstring{$\ast$}{*}}]{block\+\_\+count\+\_\+p,  }\item[{uint16\+\_\+t \texorpdfstring{$\ast$}{*}}]{block\+\_\+size\+\_\+p }\end{DoxyParamCaption})}



Gets the capacity of the disk. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em lun} & The logical unit number that the request is for. \\
\hline
\mbox{\texttt{ out}}  & {\em block\+\_\+count\+\_\+p} & The number of blocks in the disk. \\
\hline
\mbox{\texttt{ out}}  & {\em block\+\_\+size\+\_\+p} & The size of each block in bytes.\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
true if the request was successful, false otherwise. 
\end{DoxyReturn}


Definition at line \mbox{\hyperlink{msc__disk_8c_source_l00105}{105}} of file \mbox{\hyperlink{msc__disk_8c_source}{msc\+\_\+disk.\+c}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00106\ \ \ \ \ \mbox{\hyperlink{msc__disk_8c_a36ee3cef7e2f801857f2203f549d2a8c}{TRACE\_PRINTF}}(\textcolor{stringliteral}{"{}\%s(lun=\%d)\(\backslash\)n"{}},\ \_\_func\_\_,\ lun);}
\DoxyCodeLine{00107\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{msc__disk_8c_abbb293c273679cadfae2b360ccd5e437}{tud\_msc\_test\_unit\_ready\_cb}}(lun))\ \{}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ *block\_count\_p\ =\ 0;}
\DoxyCodeLine{00109\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \ \ DRESULT\ dr\ =\ disk\_ioctl(lun,\ GET\_SECTOR\_COUNT,\ block\_count\_p);}
\DoxyCodeLine{00111\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (RES\_OK\ !=\ dr)\ *block\_count\_p\ =\ 0;}
\DoxyCodeLine{00112\ \ \ \ \ \}}
\DoxyCodeLine{00113\ \ \ \ \ *block\_size\_p\ =\ 512;}
\DoxyCodeLine{00114\ \}}

\end{DoxyCode}
Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{msc__disk_8c_a187bf69a8d208e32b862489fe4caa23d_cgraph}
\end{center}
\end{figure}
\Hypertarget{msc__disk_8c_ae2aefd1e5c3d470f440cd8f07dce9991}\label{msc__disk_8c_ae2aefd1e5c3d470f440cd8f07dce9991} 
\index{msc\_disk.c@{msc\_disk.c}!tud\_msc\_inquiry\_cb@{tud\_msc\_inquiry\_cb}}
\index{tud\_msc\_inquiry\_cb@{tud\_msc\_inquiry\_cb}!msc\_disk.c@{msc\_disk.c}}
\doxysubsubsection{\texorpdfstring{tud\_msc\_inquiry\_cb()}{tud\_msc\_inquiry\_cb()}}
{\footnotesize\ttfamily void tud\+\_\+msc\+\_\+inquiry\+\_\+cb (\begin{DoxyParamCaption}\item[{uint8\+\_\+t}]{lun,  }\item[{uint8\+\_\+t}]{vendor\+\_\+id\mbox{[}8\mbox{]},  }\item[{uint8\+\_\+t}]{product\+\_\+id\mbox{[}16\mbox{]},  }\item[{uint8\+\_\+t}]{product\+\_\+rev\mbox{[}4\mbox{]} }\end{DoxyParamCaption})}



Handles the INQUIRY request. 


\begin{DoxyParams}{Parameters}
{\em lun} & The LUN that the request is for. \\
\hline
{\em vendor\+\_\+id} & The vendor ID to return. \\
\hline
{\em product\+\_\+id} & The product ID to return. \\
\hline
{\em product\+\_\+rev} & The product revision to return. \\
\hline
\end{DoxyParams}


Definition at line \mbox{\hyperlink{msc__disk_8c_source_l00067}{67}} of file \mbox{\hyperlink{msc__disk_8c_source}{msc\+\_\+disk.\+c}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00068\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00069\ \ \ \ \ \mbox{\hyperlink{msc__disk_8c_a36ee3cef7e2f801857f2203f549d2a8c}{TRACE\_PRINTF}}(\textcolor{stringliteral}{"{}\%s(lun=\%d)\(\backslash\)n"{}},\ \_\_func\_\_,\ lun);}
\DoxyCodeLine{00070\ \ \ \ \ (void)lun;}
\DoxyCodeLine{00071\ \ \ \ \ \textcolor{comment}{//\ FIXME:\ maybe\ this\ should\ come\ from\ the\ SD\ card's\ CSD?}}
\DoxyCodeLine{00072\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ vid[]\ =\ \textcolor{stringliteral}{"{}Pico\ SD"{}};}
\DoxyCodeLine{00073\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ pid[]\ =\ \textcolor{stringliteral}{"{}Mass\ Storage"{}};}
\DoxyCodeLine{00074\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ rev[]\ =\ \textcolor{stringliteral}{"{}1.0"{}};}
\DoxyCodeLine{00075\ }
\DoxyCodeLine{00076\ \ \ \ \ \textcolor{comment}{//\ Copy\ the\ vendor\ ID,\ product\ ID,\ and\ revision\ to\ the\ buffers.}}
\DoxyCodeLine{00077\ \ \ \ \ snprintf((\textcolor{keywordtype}{char}*)vendor\_id,\ 8,\ \textcolor{stringliteral}{"{}\%s"{}},\ vid);}
\DoxyCodeLine{00078\ \ \ \ \ snprintf((\textcolor{keywordtype}{char}*)product\_id,\ 16,\ \textcolor{stringliteral}{"{}\%s"{}},\ pid);}
\DoxyCodeLine{00079\ \ \ \ \ snprintf((\textcolor{keywordtype}{char}*)product\_rev,\ 4,\ \textcolor{stringliteral}{"{}\%s"{}},\ rev);}
\DoxyCodeLine{00080\ \}}

\end{DoxyCode}
\Hypertarget{msc__disk_8c_a47fd17807a02c00f4f45880d7f0ad0fa}\label{msc__disk_8c_a47fd17807a02c00f4f45880d7f0ad0fa} 
\index{msc\_disk.c@{msc\_disk.c}!tud\_msc\_is\_writable\_cb@{tud\_msc\_is\_writable\_cb}}
\index{tud\_msc\_is\_writable\_cb@{tud\_msc\_is\_writable\_cb}!msc\_disk.c@{msc\_disk.c}}
\doxysubsubsection{\texorpdfstring{tud\_msc\_is\_writable\_cb()}{tud\_msc\_is\_writable\_cb()}}
{\footnotesize\ttfamily bool tud\+\_\+msc\+\_\+is\+\_\+writable\+\_\+cb (\begin{DoxyParamCaption}\item[{uint8\+\_\+t}]{lun }\end{DoxyParamCaption})}



Returns true if the MSC is writable. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em lun} & The logical unit number that the request is for.\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
true if the MSC is writable, false otherwise. 
\end{DoxyReturn}


Definition at line \mbox{\hyperlink{msc__disk_8c_source_l00181}{181}} of file \mbox{\hyperlink{msc__disk_8c_source}{msc\+\_\+disk.\+c}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00181\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00182\ \ \ \ \ \mbox{\hyperlink{msc__disk_8c_a36ee3cef7e2f801857f2203f549d2a8c}{TRACE\_PRINTF}}(\textcolor{stringliteral}{"{}\%s(lun=\%d)\(\backslash\)n"{}},\ \_\_func\_\_,\ lun);}
\DoxyCodeLine{00183\ \ \ \ \ \textcolor{keywordflow}{if}\ (ejected)\ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00184\ }
\DoxyCodeLine{00185\ \ \ \ \ DSTATUS\ ds\ =\ disk\_status(lun);}
\DoxyCodeLine{00186\ \ \ \ \ \textcolor{keywordflow}{return}\ !(STA\_PROTECT\ \&\ ds);}
\DoxyCodeLine{00187\ \}}

\end{DoxyCode}
\Hypertarget{msc__disk_8c_a148e0153ce23f6ffd6305fb0e0fc4dfd}\label{msc__disk_8c_a148e0153ce23f6ffd6305fb0e0fc4dfd} 
\index{msc\_disk.c@{msc\_disk.c}!tud\_msc\_read10\_cb@{tud\_msc\_read10\_cb}}
\index{tud\_msc\_read10\_cb@{tud\_msc\_read10\_cb}!msc\_disk.c@{msc\_disk.c}}
\doxysubsubsection{\texorpdfstring{tud\_msc\_read10\_cb()}{tud\_msc\_read10\_cb()}}
{\footnotesize\ttfamily int32\+\_\+t tud\+\_\+msc\+\_\+read10\+\_\+cb (\begin{DoxyParamCaption}\item[{uint8\+\_\+t}]{lun,  }\item[{uint32\+\_\+t}]{lba,  }\item[{uint32\+\_\+t}]{offset,  }\item[{void \texorpdfstring{$\ast$}{*}}]{buffer,  }\item[{uint32\+\_\+t}]{bufsize }\end{DoxyParamCaption})}



Reads data from the disk. 

This callback is invoked when the host sends a READ (10) request to the device.


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em lun} & The logical unit number that the request is for. \\
\hline
\mbox{\texttt{ in}}  & {\em lba} & The logical block address to read from. \\
\hline
\mbox{\texttt{ in}}  & {\em offset} & The offset in bytes from the beginning of the block to read from. \\
\hline
\mbox{\texttt{ out}}  & {\em buffer} & The buffer to store the read data in. \\
\hline
\mbox{\texttt{ in}}  & {\em bufsize} & The size of the buffer in bytes.\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The number of bytes read from the disk. 
\end{DoxyReturn}


Definition at line \mbox{\hyperlink{msc__disk_8c_source_l00157}{157}} of file \mbox{\hyperlink{msc__disk_8c_source}{msc\+\_\+disk.\+c}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00158\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00159\ \ \ \ \ \mbox{\hyperlink{msc__disk_8c_a36ee3cef7e2f801857f2203f549d2a8c}{TRACE\_PRINTF}}(\textcolor{stringliteral}{"{}\%s(lun=\%d)\(\backslash\)n"{}},\ \_\_func\_\_,\ lun);}
\DoxyCodeLine{00160\ \ \ \ \ (void)offset;}
\DoxyCodeLine{00161\ \ \ \ \ assert(!offset);}
\DoxyCodeLine{00162\ \ \ \ \ assert(!(bufsize\ \%\ 512));}
\DoxyCodeLine{00163\ }
\DoxyCodeLine{00164\ \ \ \ \ \textcolor{keywordflow}{if}\ (ejected)\ \textcolor{keywordflow}{return}\ -\/1;}
\DoxyCodeLine{00165\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{msc__disk_8c_abbb293c273679cadfae2b360ccd5e437}{tud\_msc\_test\_unit\_ready\_cb}}(lun))\ \textcolor{keywordflow}{return}\ -\/1;}
\DoxyCodeLine{00166\ }
\DoxyCodeLine{00167\ \ \ \ \ \textcolor{comment}{//\ Read\ data\ from\ the\ disk.}}
\DoxyCodeLine{00168\ \ \ \ \ DRESULT\ dr\ =\ disk\_read(lun,\ (BYTE*)buffer,\ lba,\ bufsize\ /\ 512);}
\DoxyCodeLine{00169\ \ \ \ \ \textcolor{keywordflow}{if}\ (RES\_OK\ !=\ dr)\ \textcolor{keywordflow}{return}\ -\/1;}
\DoxyCodeLine{00170\ }
\DoxyCodeLine{00171\ \ \ \ \ \textcolor{keywordflow}{return}\ (int32\_t)bufsize;}
\DoxyCodeLine{00172\ \}}

\end{DoxyCode}
Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{msc__disk_8c_a148e0153ce23f6ffd6305fb0e0fc4dfd_cgraph}
\end{center}
\end{figure}
\Hypertarget{msc__disk_8c_a8f5dcb9aacaba9e9932f2c941d4639e3}\label{msc__disk_8c_a8f5dcb9aacaba9e9932f2c941d4639e3} 
\index{msc\_disk.c@{msc\_disk.c}!tud\_msc\_scsi\_cb@{tud\_msc\_scsi\_cb}}
\index{tud\_msc\_scsi\_cb@{tud\_msc\_scsi\_cb}!msc\_disk.c@{msc\_disk.c}}
\doxysubsubsection{\texorpdfstring{tud\_msc\_scsi\_cb()}{tud\_msc\_scsi\_cb()}}
{\footnotesize\ttfamily int32\+\_\+t tud\+\_\+msc\+\_\+scsi\+\_\+cb (\begin{DoxyParamCaption}\item[{uint8\+\_\+t}]{lun,  }\item[{uint8\+\_\+t const}]{scsi\+\_\+cmd\mbox{[}16\mbox{]},  }\item[{void \texorpdfstring{$\ast$}{*}}]{buffer,  }\item[{uint16\+\_\+t}]{bufsize }\end{DoxyParamCaption})}



Callback for handling SCSI commands. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em lun} & The logical unit number that the request is for. \\
\hline
\mbox{\texttt{ in}}  & {\em scsi\+\_\+cmd} & The SCSI command to be handled. \\
\hline
\mbox{\texttt{ in}}  & {\em buffer} & The buffer containing the data to be written. \\
\hline
\mbox{\texttt{ in}}  & {\em bufsize} & The size of the buffer in bytes.\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The number of bytes written. 
\end{DoxyReturn}


Definition at line \mbox{\hyperlink{msc__disk_8c_source_l00228}{228}} of file \mbox{\hyperlink{msc__disk_8c_source}{msc\+\_\+disk.\+c}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00229\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00230\ \ \ \ \ \mbox{\hyperlink{msc__disk_8c_a36ee3cef7e2f801857f2203f549d2a8c}{TRACE\_PRINTF}}(\textcolor{stringliteral}{"{}\%s(lun=\%d)\(\backslash\)n"{}},\ \_\_func\_\_,\ lun);}
\DoxyCodeLine{00231\ \ \ \ \ \textcolor{keywordtype}{void}\ \textcolor{keyword}{const}*\ response\ =\ NULL;}
\DoxyCodeLine{00232\ \ \ \ \ int32\_t\ resplen\ =\ 0;}
\DoxyCodeLine{00233\ }
\DoxyCodeLine{00234\ \ \ \ \ \textcolor{comment}{//\ most\ scsi\ handled\ is\ input}}
\DoxyCodeLine{00235\ \ \ \ \ \textcolor{keywordtype}{bool}\ in\_xfer\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00236\ }
\DoxyCodeLine{00237\ \ \ \ \ \textcolor{keywordflow}{switch}\ (scsi\_cmd[0])\ \{}
\DoxyCodeLine{00238\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{00239\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Set\ Sense\ =\ Invalid\ Command\ Operation}}
\DoxyCodeLine{00240\ \ \ \ \ \ \ \ \ \ \ \ \ tud\_msc\_set\_sense(lun,\ SCSI\_SENSE\_ILLEGAL\_REQUEST,\ 0x20,\ 0x00);}
\DoxyCodeLine{00241\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ negative\ means\ error\ -\/>\ tinyusb\ could\ stall\ and/or\ response\ with\ failed\ status}}
\DoxyCodeLine{00242\ \ \ \ \ \ \ \ \ \ \ \ \ resplen\ =\ -\/1;}
\DoxyCodeLine{00243\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00244\ \ \ \ \ \}}
\DoxyCodeLine{00245\ }
\DoxyCodeLine{00246\ \ \ \ \ \textcolor{comment}{//\ return\ resplen\ must\ not\ larger\ than\ bufsize}}
\DoxyCodeLine{00247\ \ \ \ \ \textcolor{keywordflow}{if}\ (resplen\ >\ bufsize)\ resplen\ =\ bufsize;}
\DoxyCodeLine{00248\ }
\DoxyCodeLine{00249\ \ \ \ \ \textcolor{keywordflow}{if}\ (response\ \&\&\ (resplen\ >\ 0))\ \{}
\DoxyCodeLine{00250\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (in\_xfer)\ \{}
\DoxyCodeLine{00251\ \ \ \ \ \ \ \ \ \ \ \ \ memcpy(buffer,\ response,\ (\textcolor{keywordtype}{size\_t})resplen);}
\DoxyCodeLine{00252\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00253\ \ \ \ \ \ \ \ \ \ \ \ \ ;\ \ \textcolor{comment}{//\ SCSI\ output}}
\DoxyCodeLine{00254\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00255\ \ \ \ \ \}}
\DoxyCodeLine{00256\ \ \ \ \ \textcolor{keywordflow}{return}\ (int32\_t)resplen;}
\DoxyCodeLine{00257\ \}}

\end{DoxyCode}
\Hypertarget{msc__disk_8c_ac5112ed309407dee0e18a97ca415929c}\label{msc__disk_8c_ac5112ed309407dee0e18a97ca415929c} 
\index{msc\_disk.c@{msc\_disk.c}!tud\_msc\_start\_stop\_cb@{tud\_msc\_start\_stop\_cb}}
\index{tud\_msc\_start\_stop\_cb@{tud\_msc\_start\_stop\_cb}!msc\_disk.c@{msc\_disk.c}}
\doxysubsubsection{\texorpdfstring{tud\_msc\_start\_stop\_cb()}{tud\_msc\_start\_stop\_cb()}}
{\footnotesize\ttfamily bool tud\+\_\+msc\+\_\+start\+\_\+stop\+\_\+cb (\begin{DoxyParamCaption}\item[{uint8\+\_\+t}]{lun,  }\item[{uint8\+\_\+t}]{power\+\_\+condition,  }\item[{bool}]{start,  }\item[{bool}]{load\+\_\+eject }\end{DoxyParamCaption})}



Callback for the Mass Storage Class\textquotesingle{}s START STOP UNIT request. 

This callback is invoked when the host sends a START STOP UNIT request to the device.


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em lun} & The logical unit number that the request is for. \\
\hline
\mbox{\texttt{ in}}  & {\em power\+\_\+condition} & The power condition of the request. \\
\hline
\mbox{\texttt{ in}}  & {\em start} & true if the request is to start the unit, false if it is to stop it. \\
\hline
\mbox{\texttt{ in}}  & {\em load\+\_\+eject} & true if the request is to load or eject the media.\\
\hline
\end{DoxyParams}

\begin{DoxyRetVals}{Return values}
{\em true} & if the request was successful, false otherwise. \\
\hline
\end{DoxyRetVals}


Definition at line \mbox{\hyperlink{msc__disk_8c_source_l00128}{128}} of file \mbox{\hyperlink{msc__disk_8c_source}{msc\+\_\+disk.\+c}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00128\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00129\ \ \ \ \ \mbox{\hyperlink{msc__disk_8c_a36ee3cef7e2f801857f2203f549d2a8c}{TRACE\_PRINTF}}(\textcolor{stringliteral}{"{}\%s(lun=\%d)\(\backslash\)n"{}},\ \_\_func\_\_,\ lun);}
\DoxyCodeLine{00130\ \ \ \ \ (void)power\_condition;}
\DoxyCodeLine{00131\ \ \ \ \ \textcolor{keywordflow}{if}\ (load\_eject)\ \{}
\DoxyCodeLine{00132\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (start)\ \{}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ load\ disk\ storage}}
\DoxyCodeLine{00134\ \ \ \ \ \ \ \ \ \ \ \ \ ejected\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00135\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00136\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ unload\ disk\ storage}}
\DoxyCodeLine{00137\ \ \ \ \ \ \ \ \ \ \ \ \ DRESULT\ dr\ =\ disk\_ioctl(lun,\ CTRL\_SYNC,\ 0);}
\DoxyCodeLine{00138\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (RES\_OK\ !=\ dr)\ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00139\ \ \ \ \ \ \ \ \ \ \ \ \ ejected\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00140\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00141\ \ \ \ \ \}}
\DoxyCodeLine{00142\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00143\ \}}

\end{DoxyCode}
\Hypertarget{msc__disk_8c_abbb293c273679cadfae2b360ccd5e437}\label{msc__disk_8c_abbb293c273679cadfae2b360ccd5e437} 
\index{msc\_disk.c@{msc\_disk.c}!tud\_msc\_test\_unit\_ready\_cb@{tud\_msc\_test\_unit\_ready\_cb}}
\index{tud\_msc\_test\_unit\_ready\_cb@{tud\_msc\_test\_unit\_ready\_cb}!msc\_disk.c@{msc\_disk.c}}
\doxysubsubsection{\texorpdfstring{tud\_msc\_test\_unit\_ready\_cb()}{tud\_msc\_test\_unit\_ready\_cb()}}
{\footnotesize\ttfamily bool tud\+\_\+msc\+\_\+test\+\_\+unit\+\_\+ready\+\_\+cb (\begin{DoxyParamCaption}\item[{uint8\+\_\+t}]{lun }\end{DoxyParamCaption})}



Checks if the unit is ready. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em lun} & The logical unit number that the request is for.\\
\hline
\end{DoxyParams}

\begin{DoxyRetVals}{Return values}
{\em true} & The unit is ready. \\
\hline
{\em false} & The unit is not ready. \\
\hline
\end{DoxyRetVals}


Definition at line \mbox{\hyperlink{msc__disk_8c_source_l00090}{90}} of file \mbox{\hyperlink{msc__disk_8c_source}{msc\+\_\+disk.\+c}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00091\ \ \ \ \ \mbox{\hyperlink{msc__disk_8c_a36ee3cef7e2f801857f2203f549d2a8c}{TRACE\_PRINTF}}(\textcolor{stringliteral}{"{}\%s(lun=\%d)\(\backslash\)n"{}},\ \_\_func\_\_,\ lun);}
\DoxyCodeLine{00092\ \ \ \ \ DSTATUS\ ds\ =\ disk\_initialize(lun);}
\DoxyCodeLine{00093\ \ \ \ \ \textcolor{keywordflow}{return}\ (!(STA\_NOINIT\ \&\ ds)\ \&\&\ !(STA\_NODISK\ \&\ ds));}
\DoxyCodeLine{00094\ \}}

\end{DoxyCode}
\Hypertarget{msc__disk_8c_a375a5cc4f5760603edf955765eca41a8}\label{msc__disk_8c_a375a5cc4f5760603edf955765eca41a8} 
\index{msc\_disk.c@{msc\_disk.c}!tud\_msc\_write10\_cb@{tud\_msc\_write10\_cb}}
\index{tud\_msc\_write10\_cb@{tud\_msc\_write10\_cb}!msc\_disk.c@{msc\_disk.c}}
\doxysubsubsection{\texorpdfstring{tud\_msc\_write10\_cb()}{tud\_msc\_write10\_cb()}}
{\footnotesize\ttfamily int32\+\_\+t tud\+\_\+msc\+\_\+write10\+\_\+cb (\begin{DoxyParamCaption}\item[{uint8\+\_\+t}]{lun,  }\item[{uint32\+\_\+t}]{lba,  }\item[{uint32\+\_\+t}]{offset,  }\item[{uint8\+\_\+t \texorpdfstring{$\ast$}{*}}]{buffer,  }\item[{uint32\+\_\+t}]{bufsize }\end{DoxyParamCaption})}



Write data to the disk. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em lun} & The logical unit number that the request is for. \\
\hline
\mbox{\texttt{ in}}  & {\em lba} & The logical block address to write to. \\
\hline
\mbox{\texttt{ in}}  & {\em offset} & The offset in bytes from the beginning of the block to write to. \\
\hline
\mbox{\texttt{ in}}  & {\em buffer} & The buffer containing the data to be written. \\
\hline
\mbox{\texttt{ in}}  & {\em bufsize} & The size of the buffer in bytes.\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The number of bytes written. 
\end{DoxyReturn}


Definition at line \mbox{\hyperlink{msc__disk_8c_source_l00201}{201}} of file \mbox{\hyperlink{msc__disk_8c_source}{msc\+\_\+disk.\+c}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00202\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00203\ \ \ \ \ \mbox{\hyperlink{msc__disk_8c_a36ee3cef7e2f801857f2203f549d2a8c}{TRACE\_PRINTF}}(\textcolor{stringliteral}{"{}\%s(lun=\%d)\(\backslash\)n"{}},\ \_\_func\_\_,\ lun);}
\DoxyCodeLine{00204\ \ \ \ \ (void)offset;}
\DoxyCodeLine{00205\ \ \ \ \ assert(!offset);}
\DoxyCodeLine{00206\ \ \ \ \ assert(!(bufsize\ \%\ 512));}
\DoxyCodeLine{00207\ }
\DoxyCodeLine{00208\ \ \ \ \ \textcolor{keywordflow}{if}\ (ejected)\ \textcolor{keywordflow}{return}\ -\/1;}
\DoxyCodeLine{00209\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{msc__disk_8c_abbb293c273679cadfae2b360ccd5e437}{tud\_msc\_test\_unit\_ready\_cb}}(lun))\ \textcolor{keywordflow}{return}\ -\/1;}
\DoxyCodeLine{00210\ }
\DoxyCodeLine{00211\ \ \ \ \ \textcolor{comment}{//\ Write\ data\ to\ the\ disk.}}
\DoxyCodeLine{00212\ \ \ \ \ DRESULT\ dr\ =\ disk\_write(lun,\ (BYTE*)buffer,\ lba,\ bufsize\ /\ 512);}
\DoxyCodeLine{00213\ \ \ \ \ \textcolor{keywordflow}{if}\ (RES\_OK\ !=\ dr)\ \textcolor{keywordflow}{return}\ -\/1;}
\DoxyCodeLine{00214\ }
\DoxyCodeLine{00215\ \ \ \ \ \textcolor{keywordflow}{return}\ bufsize;}
\DoxyCodeLine{00216\ \}}

\end{DoxyCode}
Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{msc__disk_8c_a375a5cc4f5760603edf955765eca41a8_cgraph}
\end{center}
\end{figure}
